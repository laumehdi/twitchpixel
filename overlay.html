<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Overlay Alpha Gold V22</title>
  <style>
    /* === Solarized Dark Palette ===
       base03: #002b36  base02: #073642  base01: #586e75  base00: #657b83
       base0:  #839496  base1:  #93a1a1  base2:  #eee8d5  base3:  #fdf6e3
       yellow: #b58900  orange: #cb4b16  red:    #dc322f  magenta:#d33682
       violet: #6c71c4  blue:   #268bd2  cyan:   #2aa198  green:  #859900
    */

    html, body { 
      margin: 0; padding: 0; 
      background: transparent !important; 
      overflow: hidden; width: 1920px; height: 1080px;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    
    #container { 
      position: absolute; width: 100%; height: 100%; 
      top: 0; left: 0; pointer-events: none; 
    }

    #status {
      position: absolute; top: 10px; left: 10px;
      color: #ffcc00; font-weight: bold; font-size: 24px;
      text-shadow: 2px 2px 0 #000;
      z-index: 99999;
      font-family: monospace;
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      padding: 10px;
      display: none; 
    }
    
    .item { 
      position: absolute; 
      top: 0; left: 0; 
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 165px;
      will-change: transform; 
    }

    canvas.pixel-art { 
      image-rendering: pixelated; 
      width: 165px; height: 165px; 
      background: transparent; 
      z-index: 2; 
    }

    @keyframes jumpBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-30px); } 
    }

    .jumping canvas {
      animation: jumpBounce 0.8s ease-in-out infinite;
    }

    .is-sub canvas { filter: brightness(1.15); }
    
    .nick { 
      color: white; font-weight: 900; font-size: 22px; 
      width: 280px; text-align: center; margin-top: 2px;
      white-space: nowrap; text-shadow: 2px 2px 0 #000; z-index: 3;
    }

    .is-sub .nick { color: #FFD700; }

    /* === SHOWCASE === */
    .showcase {
      position: fixed !important; top: 50% !important; left: 50% !important;
      z-index: 99999 !important; will-change: transform;
      animation: superDance 0.8s infinite ease-in-out !important;
    }
    .showcase::before {
      content: ''; position: absolute; top: 50%; left: 50%;
      width: 280px; height: 280px; transform: translate(-50%, -60%); 
      z-index: 1; border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,224,0.9) 0%, rgba(255,215,0,0.5) 40%, transparent 70%);
      animation: auraPulse 1.5s infinite alternate ease-in-out;
    }
    .showcase canvas { filter: brightness(1.1); }
    .showcase .nick {
       font-size: 33px !important;
       text-shadow: 3px 3px 0 #000, 0 0 10px rgba(0,0,0,0.5);
       margin-top: 15px;
    }
    @keyframes superDance {
      0%   { transform: translate(-50%, -50%) scale(4.1) rotate(0deg); }
      25%  { transform: translate(-50%, -50%) scale(4.4) rotate(-5deg); } 
      50%  { transform: translate(-50%, -50%) scale(4.1) rotate(0deg) translateY(-15px); } 
      75%  { transform: translate(-50%, -50%) scale(4.4) rotate(5deg); }
      100% { transform: translate(-50%, -50%) scale(4.1) rotate(0deg); }
    }
    @keyframes auraPulse {
      0% { transform: translate(-50%, -60%) scale(1); opacity: 0.7; }
      100% { transform: translate(-50%, -60%) scale(1.15); opacity: 1; }
    }

    .hidden { display: none !important; }
    .waiting { opacity: 0; }

    .spiral-to-lane {
      position: absolute !important; z-index: 99998 !important;
      will-change: transform; pointer-events: none;
    }
    .spiral-to-lane .nick {
      transition: font-size 1.2s ease-in;
      font-size: 22px !important;
    }

    /* ============================================
       TEST PANEL - Solarized Light (default)
       Dark mode auto-detected via prefers-color-scheme
       ============================================ */

    /* --- Solarized CSS Variables --- */
    :root {
      --sol-bg:       #fdf6e3;
      --sol-bg-alt:   #eee8d5;
      --sol-border:   #93a1a1;
      --sol-text:     #657b83;
      --sol-text-dim: #93a1a1;
      --sol-text-emph:#586e75;
      --sol-shadow:   rgba(0,0,0,0.12);
      --sol-scrollbar: #93a1a1;
      --sol-line-border: #eee8d5;
      /* accent colors are the same in both themes */
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --sol-bg:       #002b36;
        --sol-bg-alt:   #073642;
        --sol-border:   #073642;
        --sol-text:     #839496;
        --sol-text-dim: #586e75;
        --sol-text-emph:#93a1a1;
        --sol-shadow:   rgba(0,0,0,0.5);
        --sol-scrollbar: #586e75;
        --sol-line-border: #073642;
      }
    }

    #test-bar {
      display: none;
      position: fixed;
      bottom: 10px; left: 10px;
      z-index: 100000;
      pointer-events: auto;
      font-family: 'Segoe UI', sans-serif;
      flex-direction: row;
      align-items: flex-end;
      gap: 10px;
    }

    #test-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      max-width: 340px;
      padding: 10px;
      background: var(--sol-bg);
      border-radius: 10px;
      border: 1px solid var(--sol-border);
      box-shadow: 0 4px 20px var(--sol-shadow);
    }

    #test-buttons button {
      padding: 9px 14px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s, filter 0.1s;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      font-family: 'Segoe UI', sans-serif;
    }
    #test-buttons button:hover { transform: scale(1.05); filter: brightness(1.15); }
    #test-buttons button:active { transform: scale(0.97); }

    .btn-user    { background: #859900; color: #fdf6e3; }
    .btn-sub     { background: #b58900; color: #fdf6e3; }
    .btn-speed   { background: #268bd2; color: #fdf6e3; }
    .btn-rain    { background: #6c71c4; color: #fdf6e3; }
    .btn-boom    { background: #dc322f; color: #fdf6e3; font-size: 14px !important; }
    .btn-exit    { background: #586e75; color: #fdf6e3; }
    .btn-clear   { background: #cb4b16; color: #fdf6e3; }

    .btn-speed.active { box-shadow: 0 0 0 2px #2aa198; }

    /* === CONSOLA Solarized === */
    #test-console {
      width: 480px; height: 260px;
      background: var(--sol-bg);
      border: 1px solid var(--sol-border);
      border-radius: 10px;
      box-shadow: 0 4px 20px var(--sol-shadow);
      font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      font-size: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #test-console-header {
      padding: 6px 12px;
      background: var(--sol-bg-alt);
      color: var(--sol-text-emph);
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid var(--sol-border);
      display: flex;
      justify-content: space-between;
    }

    #test-console-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
    }

    #test-console-body::-webkit-scrollbar { width: 6px; }
    #test-console-body::-webkit-scrollbar-track { background: var(--sol-bg); }
    #test-console-body::-webkit-scrollbar-thumb { background: var(--sol-scrollbar); border-radius: 3px; }

    .log-line {
      padding: 2px 0;
      line-height: 1.5;
      color: var(--sol-text);
      border-bottom: 1px solid var(--sol-line-border);
    }
    .log-line .time   { color: var(--sol-text-dim); }
    .log-line .tag-lane  { color: #2aa198; }
    .log-line .tag-user  { color: #859900; }
    .log-line .tag-sub   { color: #b58900; }
    .log-line .tag-boom  { color: #dc322f; }
    .log-line .tag-speed { color: #268bd2; }
    .log-line .tag-rain  { color: #6c71c4; }
    .log-line .tag-info  { color: var(--sol-text-dim); }
  </style>
</head>
<body>
  <div id="status">CARGANDO...</div>
  <div id="container"></div>

  <!-- TEST BAR: botones a la izquierda, consola a la derecha -->
  <div id="test-bar">
    <div id="test-buttons">
      <button class="btn-user" onclick="testAddUser()">‚ûï Usuario</button>
      <button class="btn-sub" onclick="testAddSub()">‚≠ê Sub</button>
      <button class="btn-speed" id="btn-spd1" onclick="testSpeed(1)">üê¢ Vel 1</button>
      <button class="btn-speed" id="btn-spd2" onclick="testSpeed(2)">üêá Vel 2</button>
      <button class="btn-rain" onclick="toggleRain()">üåßÔ∏è Lluvia</button>
      <button class="btn-boom" onclick="triggerBoom()">üí• BOOM</button>
      <button class="btn-clear" onclick="removeAllDrawingsGlobal(); logConsole('info', 'Todos los dibujos eliminados')">üóëÔ∏è Limpiar</button>
      <button class="btn-exit" onclick="toggleTest()">‚ùå Salir</button>
    </div>
    <div id="test-console">
      <div id="test-console-header">
        <span>üìü Consola</span>
        <span id="console-stats"></span>
      </div>
      <div id="test-console-body"></div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let channelParam = urlParams.get('channel');
    if (!channelParam && window.location.search.length > 1) {
        channelParam = window.location.search.substring(1).replace('=', '');
    }
    const CHANNEL = channelParam || 'laumehdi'; 
    
    const colors = ['transparent','#000000','#aa0000','#00aa00','#aa5500','#0000aa','#aa00aa','#00aaaa','#aaaaaa','#555555','#ff5555','#55ff55','#ffff55','#5555ff','#ff55ff','#55ffff','#ffffff'];
    
    const TEST_CODE = "v2000000008751AB52361D2B535F574F83769CC2C3C7FFCCAAFF004D00E436FFEC2729ADFFFF77A8FFF1E8_AAAAAAAAAAAAmQAAAA3QAAmZqqu8zd7uCZmqq7zM3u4AIiM0REjdMAAiY3dEQRMwAAZnd3GIVQMAAAB3cYhVUBEREQABEREQABABAAABABEAEAABAAEBAAAQEREAAQEAABAREAABAQAAEBAAEBABAAAAEAEREAEAAAAREA==";

    const RANDOM_NAMES = [
      'PixelMaster','xDarkSoul','CoolCat99','TwitchFan','GamerGirl','NightOwl42',
      'StarPlayer','MoonWalk','FireStorm','IceQueen','ShadowNinja','ThunderBolt',
      'CosmicDust','NeonLight','RetroGamer','DigitalArt','PixelPunk','ChipTune',
      'BitCrusher','WaveRider','CyberWolf','TurboFox','LaserBeam','RocketFuel',
      'QuantumLeap','ZeroGravity','SuperNova','MegaByte','HyperLink','GlitchHop'
    ];

    let drawings = []; 
    let testMode = false;
    let rainMode = false; 
    let boomMode = false;
    let subQueue = [];
    let isShowcaseBusy = false;
    let ws = null;
    let activeCodes = new Set(); 
    let testUserCounter = 0;
    let boomTimer = null;

    let globalSpeedMultiplier = 0.54; 

    const LANES = [10, 40, 70, 100]; 
    const SPEEDS = [2, 3.5, 2.5, 4.5]; 
    const Z_INDEXES = [5, 20, 10, 30];

    let lastTime = performance.now();

    // === CONSOLA ===
    function logConsole(tag, message) {
      if (!testMode) return;
      const body = document.getElementById('test-console-body');
      const now = new Date();
      const timeStr = now.toLocaleTimeString('es', { hour12: false });
      const line = document.createElement('div');
      line.className = 'log-line';
      line.innerHTML = `<span class="time">${timeStr}</span> <span class="tag-${tag}">[${tag.toUpperCase()}]</span> ${message}`;
      body.appendChild(line);
      body.scrollTop = body.scrollHeight;
      while (body.children.length > 200) body.removeChild(body.firstChild);
      updateConsoleStats();
    }

    function updateConsoleStats() {
      const el = document.getElementById('console-stats');
      if (!el) return;
      const lc = [0,0,0,0];
      drawings.forEach(d => { if (!d.el.classList.contains('showcase') && !d.el.classList.contains('hidden')) lc[d.lane]++; });
      el.textContent = `Total: ${drawings.length} | C1:${lc[0]} C2:${lc[1]} C3:${lc[2]} C4:${lc[3]} | Vel: ${globalSpeedMultiplier >= 0.9 ? '2' : '1'}`;
    }

    function getMinXInLane(laneIdx, excludeObj) {
      let minX = Infinity;
      drawings.forEach(d => {
        if (d !== excludeObj && d.lane === laneIdx && !d.el.classList.contains('showcase')) {
          if (d.x < minX) minX = d.x;
        }
      });
      return minX === Infinity ? -200 : minX;
    }

    // Helper: dar velocidades de boom a un dibujo
    function assignBoomPhysics(d) {
      d.el.classList.remove('jumping');
      const angle = Math.random() * Math.PI * 2;
      const speed = 3 + Math.random() * 5;
      d.boomVx = Math.cos(angle) * speed;
      d.boomVy = Math.sin(angle) * speed;
      d.boomRot = 0;
      d.boomRotSpeed = (Math.random() - 0.5) * 12;
    }

    // === LOOP PRINCIPAL ===
    function animate(currentTime) {
      if (!currentTime) currentTime = performance.now();
      const dt = Math.min((currentTime - lastTime) / 16.666, 3);
      lastTime = currentTime;
      const now = Date.now(); 

      for (let i = drawings.length - 1; i >= 0; i--) {
        let d = drawings[i];
        if (d.el.classList.contains('showcase') || d.el.classList.contains('hidden')) continue;
        if (d.el.classList.contains('spiral-to-lane')) continue;
        
        if (d.el.classList.contains('waiting')) {
             d.el.style.transform = 'translate3d(-500px, -500px, 0)';
             continue;
        }

        // === BOOM ===
        if (boomMode) {
            d.el.style.opacity = 1;
            d.x += d.boomVx * dt;
            d.y += d.boomVy * dt;
            d.boomRot += d.boomRotSpeed * dt;

            if (d.x < -80)   { d.x = -80;  d.boomVx = Math.abs(d.boomVx); }
            if (d.x > 1840)  { d.x = 1840; d.boomVx = -Math.abs(d.boomVx); }
            if (d.y < -80)   { d.y = -80;  d.boomVy = Math.abs(d.boomVy); }
            if (d.y > 980)   { d.y = 980;  d.boomVy = -Math.abs(d.boomVy); }

            d.el.style.transform = `translate3d(${d.x}px, ${d.y}px, 0) rotate(${d.boomRot}deg)`;
            continue;
        }
        
        // === RAIN ===
        if (rainMode) {
            d.el.style.opacity = 1; 
            d.y += (d.rainSpeed * dt); 
            const sway = Math.sin((now / 800) + d.rainPhase) * 20; 
            d.x = d.rainOriginX + sway;
            d.el.style.transform = `translate3d(${d.x}px, ${d.y}px, 0)`;
            if (d.y > 1100) { d.y = -180; d.rainOriginX = Math.random() * 1800; }
            continue; 
        }

        // === DYING ===
        if (d.dying) {
            d.vy += 0.5 * dt; 
            d.y += d.vy * dt; 
            d.rot += 5 * dt;
            d.el.style.transform = `translate3d(${d.x}px, ${d.y}px, 0) rotate(${d.rot}deg)`;
            d.el.style.opacity = (1 - (d.y / 1500)); 
            if (d.y > 1200) { d.el.remove(); activeCodes.delete(d.code); drawings.splice(i, 1); continue; }
        } else {
            // === NORMAL WALK ===
            d.el.style.opacity = 1;
            d.x += (d.speed * globalSpeedMultiplier) * dt;
            
            if (d.x > 2200) { 
              d.loops++; 
              if (d.loops >= 1) d.el.classList.remove('jumping');

              const oldLane = d.lane;
              const newLaneIdx = Math.floor(Math.random() * LANES.length);
              d.lane = newLaneIdx;
              d.y = LANES[newLaneIdx];
              d.speed = SPEEDS[newLaneIdx];
              d.el.style.zIndex = Z_INDEXES[newLaneIdx];
              d.x = getMinXInLane(newLaneIdx, d) - 350;

              logConsole('lane', `<b>${d.user}</b> loop #${d.loops} ‚Üí carril ${newLaneIdx + 1} ${oldLane !== newLaneIdx ? '(cambi√≥)' : '(mismo)'}`);
            }
            d.el.style.transform = `translate3d(${d.x}px, ${d.y}px, 0)`;
        }
      }
      requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);

    // === TWITCH ===
    function connectTwitch() {
      if (ws) { try { ws.close(); } catch(e){} }
      const statusEl = document.getElementById('status');
      statusEl.style.display = 'block';
      statusEl.innerText = "CONECTANDO A: " + CHANNEL.toUpperCase();
      ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
      ws.onopen = () => {
        statusEl.innerText = "¬°CONECTADO! VELOCIDAD: " + (globalSpeedMultiplier >= 0.9 ? "2" : "1");
        setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
        ws.send('CAP REQ :twitch.tv/tags');
        ws.send('PASS oauth:none');
        ws.send('NICK justinfan' + Math.floor(Math.random()*99999));
        ws.send('JOIN #' + CHANNEL.toLowerCase());
      };
      ws.onclose = () => { statusEl.innerText = "DESCONECTADO"; statusEl.style.display = 'block'; setTimeout(connectTwitch, 3000); };
      ws.onerror = (e) => { console.error('WebSocket error:', e); };
      ws.onmessage = (e) => handleMessage(e.data);
    }

    function handleMessage(data) {
      if (data.startsWith('PING')) { ws.send('PONG :tmi.twitch.tv'); return; }
      if (data.indexOf('PRIVMSG') !== -1) {
        const parts = data.split('PRIVMSG #' + CHANNEL.toLowerCase() + ' :');
        if (!parts[1]) return;
        
        const msg = parts[1].trim();
        const rawTags = data.split('PRIVMSG')[0];
        const userMatch = data.match(/:(\w+)!/);
        const user = userMatch ? userMatch[1].toLowerCase() : 'unknown';
        const isSub = /subscriber=1/.test(rawTags) || /badges=[^;]*(?:subscriber|founder)/.test(rawTags);
        const isAdmin = (user === CHANNEL.toLowerCase());

        const args = msg.split(' ');
        const command = args[0].toLowerCase();
        const argTarget = args[1] ? args[1].replace('@', '').toLowerCase() : null;

        if (command === '!dibujar') {
          if (args[1]) createDrawing(user, args[1], isSub, false);
        } 
        else if (command === '!borrar') {
          if (isAdmin && argTarget) removeLastDrawing(argTarget);
          else removeLastDrawing(user);
        } 
        else if (command === '!limpiar') {
          if (isAdmin && argTarget) removeAllDrawingsForUser(argTarget);
          else if (isAdmin) removeAllDrawingsGlobal();
          else removeAllDrawingsForUser(user);
        }
        else if (command === '!test' && isAdmin) { toggleTest(); }
        else if (command === '!fin' && isAdmin) { toggleRain(); }
        else if (command === '!boom' && isAdmin) { triggerBoom(); }
        else if (command === '!velocidad' && isAdmin) {
             const level = args[1];
             if (level === '1') { globalSpeedMultiplier = 0.54; logConsole('speed', 'Velocidad ‚Üí 1 (lenta)'); } 
             else if (level === '2') { globalSpeedMultiplier = 1.0; logConsole('speed', 'Velocidad ‚Üí 2 (r√°pida)'); }
        }
      }
    }

    // === BORRADO ===
    function removeLastDrawing(targetUser) {
      for (let i = drawings.length - 1; i >= 0; i--) {
        if (drawings[i].user === targetUser) {
          drawings[i].el.remove(); activeCodes.delete(drawings[i].code); drawings.splice(i, 1); return; 
        }
      }
    }

    function removeAllDrawingsForUser(targetUser) {
      drawings = drawings.filter(d => {
        if (d.user === targetUser) { d.el.remove(); activeCodes.delete(d.code); return false; }
        return true; 
      });
    }

    function removeAllDrawingsGlobal() {
       drawings.forEach(d => d.el.remove());
       drawings = []; activeCodes.clear(); subQueue = []; isShowcaseBusy = false;
    }

    // === CREAR DIBUJO ===
    function createDrawing(user, fullCode, isSub, isTest, forceX) {
      if (fullCode) fullCode = fullCode.replace(/=+$/, '');
      if (!isTest && activeCodes.has(fullCode)) return;
      
      try {
        let pixelData = [], finalPalette = [];
        const isV2 = fullCode.indexOf('v2') === 0; 
        if (isV2) {
          const cleanCode = fullCode.substring(2);
          const [headerHex, payload] = cleanCode.split('_');
          if (!headerHex || !payload) return;
          finalPalette.push('transparent'); 
          for (let i = 0; i < headerHex.length; i += 6) finalPalette.push('#' + headerHex.substring(i, i+6));
          const binaryString = atob(payload);
          for (let i = 0; i < binaryString.length; i++) {
            const byte = binaryString.charCodeAt(i);
            pixelData.push((byte >> 4) & 0x0F, byte & 0x0F);
          }
        } else {
          const [header, payload] = fullCode.split('_');
          if (!header || !payload) return;
          const safePayloadLen = payload.length - (payload.length % 2);
          for (let i = 0; i < safePayloadLen; i += 2) {
            const colorIdx = parseInt(payload[i], 16), count = parseInt(payload[i+1], 36);
            if (isNaN(colorIdx) || isNaN(count) || count > 256) continue;
            for (let j = 0; j < count; j++) pixelData.push(colorIdx);
          }
          for(let i=0; i < header.length; i++) {
            if (header[i] === '1' && header[i+1] === '0') { finalPalette.push(colors[16]); i++; }
            else { finalPalette.push(colors[parseInt(header[i], 16)]); }
          }
        }

        if (pixelData.length === 0 || finalPalette.length === 0) return;

        const itemEl = document.createElement('div');
        itemEl.className = 'item';
        const canvas = document.createElement('canvas');
        canvas.className = 'pixel-art';
        canvas.width = 16; canvas.height = 16;
        const ctx = canvas.getContext('2d');
        pixelData.forEach((idx, k) => {
          if (finalPalette[idx] && finalPalette[idx] !== 'transparent') {
            ctx.fillStyle = finalPalette[idx];
            ctx.fillRect(k % 16, Math.floor(k / 16), 1, 1);
          }
        });

        if (isSub) {
            itemEl.classList.add('is-sub');
            if (!isTest) itemEl.classList.add('waiting');
        }
        if (!isSub) itemEl.classList.add('jumping');

        if (testMode && !isTest) itemEl.classList.add('hidden');
        itemEl.appendChild(canvas);
        const nickEl = document.createElement('div');
        nickEl.className = 'nick'; 
        nickEl.innerText = (isSub ? '‚≠ê ' : '') + user;
        itemEl.appendChild(nickEl);
        
        const laneIdx = drawings.length % 4;
        itemEl.style.zIndex = Z_INDEXES[laneIdx]; 
        document.getElementById('container').appendChild(itemEl);

        let obj = { 
            el: itemEl, user, code: fullCode, lane: laneIdx, 
            speed: SPEEDS[laneIdx], y: LANES[laneIdx], x: forceX || -400, 
            isTest, dying: false, vy: 0, rot: 0,
            rainOriginX: 0, rainSpeed: 1, rainPhase: 0, loops: 0,
            boomVx: 0, boomVy: 0, boomRot: 0, boomRotSpeed: 0
        };

        if (forceX === undefined) {
          obj.x = getMinXInLane(laneIdx, null) - 350;
        }
        obj.rainOriginX = obj.x;
        drawings.push(obj);

        if (!isTest) activeCodes.add(fullCode);
        if (isSub) { subQueue.push(obj); processQueue(); }

        logConsole(isSub ? 'sub' : 'user', `<b>${user}</b> ‚Üí carril ${laneIdx + 1} (${isSub ? 'SUB' : 'normal'})`);
      } catch(e) { console.error(e); }
    }

    // === SHOWCASE + ESPIRAL ===
    function processQueue() {
      if (!isShowcaseBusy && subQueue.length > 0) {
        isShowcaseBusy = true;
        const current = subQueue.shift();
        current.el.classList.remove('waiting', 'hidden');
        current.el.classList.add('showcase');
        logConsole('sub', `üéâ <b>${current.user}</b> BAILANDO en showcase`);

        setTimeout(() => {
          current.el.classList.remove('showcase');

          // FIX: Si boom est√° activo, saltar la espiral y mandar directo a volar
          if (boomMode) {
            current.el.style.transform = '';
            current.x = 960;
            current.y = 540;
            assignBoomPhysics(current);
            logConsole('boom', `üí• <b>${current.user}</b> sale del showcase directo al BOOM`);
            isShowcaseBusy = false;
            processQueue();
            return;
          }

          current.el.classList.add('spiral-to-lane');
          logConsole('sub', `üåÄ <b>${current.user}</b> espiral ‚Üí carril ${current.lane + 1}`);

          const targetX = 50;
          const targetY = LANES[current.lane];
          const startX = 960, startY = 540;
          const startScale = 4.1, endScale = 1;
          const totalSpins = 4;
          const duration = 1400;
          const startTime = performance.now();

          function spiralStep(now) {
            const elapsed = now - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const ease = 1 - Math.pow(1 - progress, 3);

            const cx = startX + (targetX - startX) * ease;
            const cy = startY + (targetY - startY) * ease;
            const cs = startScale + (endScale - startScale) * ease;
            const cr = totalSpins * 360 * progress;

            current.el.style.transform = `translate3d(${cx}px, ${cy}px, 0) scale(${cs}) rotate(${cr}deg)`;

            if (progress < 1) {
              requestAnimationFrame(spiralStep);
            } else {
              current.el.classList.remove('spiral-to-lane');
              current.el.style.transform = '';
              current.x = targetX;
              current.y = targetY;

              // FIX: Si boom se activ√≥ DURANTE la espiral, mandar a volar
              if (boomMode) {
                assignBoomPhysics(current);
                logConsole('boom', `üí• <b>${current.user}</b> termin√≥ espiral, se une al BOOM`);
              } else {
                current.el.classList.add('jumping');
                current.loops = 0;
                logConsole('sub', `‚úÖ <b>${current.user}</b> aterriz√≥ en carril ${current.lane + 1}, caminando`);
              }
              
              isShowcaseBusy = false;
              processQueue();
            }
          }
          requestAnimationFrame(spiralStep);
        }, 10000);
      }
    }

    // === BOOM ===
    function triggerBoom() {
      if (boomMode) return;
      if (drawings.length === 0) { logConsole('boom', 'No hay dibujos para explotar'); return; }
      
      boomMode = true;
      rainMode = false;
      logConsole('boom', `üí•üí•üí• BOOM ACTIVADO ‚Äî ${drawings.length} dibujos rebotando por 25s`);

      drawings.forEach(d => {
        if (d.el.classList.contains('showcase') || d.el.classList.contains('waiting') || d.el.classList.contains('spiral-to-lane')) return;
        assignBoomPhysics(d);
      });

      if (boomTimer) clearTimeout(boomTimer);
      boomTimer = setTimeout(() => {
        boomMode = false;
        logConsole('boom', 'üí• BOOM terminado ‚Äî volviendo a carriles');
        drawings.forEach((d, idx) => {
          if (d.el.classList.contains('showcase') || d.el.classList.contains('waiting')) return;
          const laneIdx = idx % LANES.length;
          d.lane = laneIdx;
          d.y = LANES[laneIdx];
          d.speed = SPEEDS[laneIdx];
          d.el.style.zIndex = Z_INDEXES[laneIdx];
          d.x = getMinXInLane(laneIdx, d) - 350;
          d.el.style.transform = `translate3d(${d.x}px, ${d.y}px, 0)`;
        });
      }, 25000);
    }

    // === TEST PANEL ===
    function testAddUser() {
      testUserCounter++;
      const name = RANDOM_NAMES[Math.floor(Math.random() * RANDOM_NAMES.length)] + '_' + testUserCounter;
      createDrawing(name, TEST_CODE, false, true);
    }

    function testAddSub() {
      testUserCounter++;
      const name = RANDOM_NAMES[Math.floor(Math.random() * RANDOM_NAMES.length)] + '_' + testUserCounter;
      createDrawing(name, TEST_CODE, true, true);
    }

    function testSpeed(level) {
      if (level === 1) globalSpeedMultiplier = 0.54;
      else if (level === 2) globalSpeedMultiplier = 1.0;
      document.getElementById('btn-spd1').classList.toggle('active', level === 1);
      document.getElementById('btn-spd2').classList.toggle('active', level === 2);
      logConsole('speed', `Velocidad ‚Üí ${level} (${level === 1 ? 'lenta' : 'r√°pida'})`);
      updateConsoleStats();
    }

    let testSpawnTimer = null;

    function toggleTest() {
      testMode = !testMode;
      const bar = document.getElementById('test-bar');

      if (testMode) {
        drawings.forEach(d => { if(!d.isTest) d.el.classList.add('hidden'); });
        
        bar.style.display = 'flex';
        document.getElementById('test-console-body').innerHTML = '';

        document.getElementById('btn-spd1').classList.toggle('active', globalSpeedMultiplier < 0.9);
        document.getElementById('btn-spd2').classList.toggle('active', globalSpeedMultiplier >= 0.9);

        logConsole('info', 'üß™ Modo test ACTIVADO');
        logConsole('info', `Carriles: ${LANES.length} | Velocidad: ${globalSpeedMultiplier >= 0.9 ? '2' : '1'}`);

        let botIndex = 0;
        const totalBots = 8;
        testSpawnTimer = setInterval(() => {
          if (botIndex >= totalBots || !testMode) { clearInterval(testSpawnTimer); testSpawnTimer = null; return; }
          const isSub = Math.random() < 0.15;
          testUserCounter++;
          const name = RANDOM_NAMES[Math.floor(Math.random() * RANDOM_NAMES.length)] + '_' + testUserCounter;
          createDrawing(name, TEST_CODE, isSub, true);
          botIndex++;
        }, 800);

      } else {
        if (testSpawnTimer) { clearInterval(testSpawnTimer); testSpawnTimer = null; }
        if (boomTimer) { clearTimeout(boomTimer); boomTimer = null; }
        boomMode = false;
        rainMode = false;
        
        bar.style.display = 'none';

        drawings = drawings.filter(d => {
          if(d.isTest) { d.el.remove(); return false; }
          d.el.classList.remove('hidden'); return true;
        });
      }
    }

    function toggleRain() {
        rainMode = !rainMode;
        if (boomMode) { boomMode = false; if (boomTimer) { clearTimeout(boomTimer); boomTimer = null; } }
        logConsole('rain', rainMode ? 'üåßÔ∏è Lluvia ACTIVADA' : '‚òÄÔ∏è Lluvia DESACTIVADA');
        drawings.forEach(d => {
            if (rainMode) { d.rainOriginX = d.x; d.rainSpeed = 0.8 + Math.random() * 2; d.rainPhase = Math.random() * 7; }
            else { d.y = LANES[d.lane]; }
        });
    }

    connectTwitch();
  </script>
</body>
</html>
